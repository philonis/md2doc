<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO æ ¸å¿ƒä¼˜åŒ– -->
    <title>Markdownè½¬æ¢å·¥å…· - ä¸“ä¸šç‰ˆ | åœ¨çº¿Markdownè½¬PDF/Docx/é•¿å›¾</title>
    <meta name="description" content="ä¸“ä¸šçš„Markdownè½¬æ¢å·¥å…·ï¼Œæ”¯æŒå®æ—¶é¢„è§ˆã€Markdownè½¬PDFã€Markdownè½¬Docxã€Markdownç”Ÿæˆé•¿å›¾ï¼Œé€‚é…ç§»åŠ¨ç«¯ï¼Œæ“ä½œç®€å•é«˜æ•ˆã€‚">
    <meta name="keywords" content="Markdownè½¬æ¢,Markdownè½¬PDF,Markdownè½¬Docx,Markdowné•¿å›¾,åœ¨çº¿Markdownç¼–è¾‘å™¨,å®æ—¶é¢„è§ˆMarkdown">
    <meta name="author" content="Markdownè½¬æ¢ä¸“å®¶å›¢é˜Ÿ">
    <meta name="robots" content="index, follow">
    <meta name="revisit-after" content="1 day">
    <meta name="language" content="zh-CN">
    
    <!-- Open Graph ç¤¾äº¤SEOä¼˜åŒ– -->
    <meta property="og:title" content="Markdownè½¬æ¢å·¥å…· - ä¸“ä¸šç‰ˆ | åœ¨çº¿Markdownè½¬PDF/Docx/é•¿å›¾">
    <meta property="og:description" content="ä¸“ä¸šçš„Markdownè½¬æ¢å·¥å…·ï¼Œæ”¯æŒå®æ—¶é¢„è§ˆã€Markdownè½¬PDFã€Markdownè½¬Docxã€Markdownç”Ÿæˆé•¿å›¾ï¼Œé€‚é…ç§»åŠ¨ç«¯ï¼Œæ“ä½œç®€å•é«˜æ•ˆã€‚">
    <meta property="og:type" content="tool">
    <meta property="og:url" content="https://yourdomain.com/md2doc.html">
    <meta property="og:site_name" content="Markdownè½¬æ¢ä¸“å®¶">
    <meta property="og:locale" content="zh_CN">
    
    <!-- Twitter å¡ç‰‡ä¼˜åŒ– -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Markdownè½¬æ¢å·¥å…· - ä¸“ä¸šç‰ˆ | åœ¨çº¿Markdownè½¬PDF/Docx/é•¿å›¾">
    <meta name="twitter:description" content="ä¸“ä¸šçš„Markdownè½¬æ¢å·¥å…·ï¼Œæ”¯æŒå®æ—¶é¢„è§ˆã€Markdownè½¬PDFã€Markdownè½¬Docxã€Markdownç”Ÿæˆé•¿å›¾ï¼Œé€‚é…ç§»åŠ¨ç«¯ï¼Œæ“ä½œç®€å•é«˜æ•ˆã€‚">
    
    <!-- GEO åœ°ç†ä¼˜åŒ– & ç»“æ„åŒ–æ•°æ® -->
    <meta name="geo.placename" content="ä¸­å›½">
    <meta name="geo.country" content="CN">
    <meta name="geo.position" content="39.9042;116.4074"> <!-- åŒ—äº¬ç»çº¬åº¦ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚ä¿®æ”¹ -->
    <meta name="ICBM" content="39.9042, 116.4074"> <!-- åŒä¸Š -->
    
    <!-- ç»“æ„åŒ–æ•°æ®ï¼ˆSchema.orgï¼‰- é¢å‘å¤§æ¨¡å‹ä¼˜åŒ– -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Markdownè½¬æ¢å·¥å…· - ä¸“ä¸šç‰ˆ",
        "description": "ä¸“ä¸šçš„Markdownè½¬æ¢å·¥å…·ï¼Œæ”¯æŒå®æ—¶é¢„è§ˆã€Markdownè½¬PDFã€Markdownè½¬Docxã€Markdownç”Ÿæˆé•¿å›¾ï¼Œé€‚é…ç§»åŠ¨ç«¯ï¼Œæ“ä½œç®€å•é«˜æ•ˆã€‚",
        "url": "https://yourdomain.com/md2doc.html",
        "applicationCategory": "ProductivityApplication",
        "operatingSystem": "Web",
        "offers": {
            "@type": "Offer",
            "price": "0.00",
            "priceCurrency": "CNY"
        },
        "featureList": [
            "Markdownå®æ—¶é¢„è§ˆ",
            "Markdownè½¬PDF",
            "Markdownè½¬Docx",
            "Markdownç”Ÿæˆé•¿å›¾",
            "ç§»åŠ¨ç«¯é€‚é…",
            "æ•°å­¦å…¬å¼æ”¯æŒ",
            "è¡¨æ ¼æ¸²æŸ“ä¼˜åŒ–"
        ],
        "author": {
            "@type": "Organization",
            "name": "Markdownè½¬æ¢ä¸“å®¶å›¢é˜Ÿ"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Markdownè½¬æ¢ä¸“å®¶å›¢é˜Ÿ",
            "url": "https://yourdomain.com"
        }
    }
    </script>

    <!-- åŸºç¡€åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.min.js"></script>
    <!-- å¼•å…¥ html2canvas åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- å¼•å…¥ html2pdf åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- å¼•å…¥ docx-preview åº“ç”¨äºDOCXè½¬PDF -->
    <script src="https://unpkg.com/docx-preview@0.1.15/dist/docx-preview.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code&family=Inter:wght@400;600&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #f9fafb;
        }

        /* å“åº”å¼å®¹å™¨å¸ƒå±€ */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: row; /* é»˜è®¤æ¨ªå‘ */
            overflow: hidden;
            position: relative;
        }

        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column; /* æ‰‹æœºç«¯çºµå‘å †å  */
            }
            #editor, #preview {
                width: 100% !important;
                height: 50% !important;
            }
            #editor {
                border-right: none;
                border-bottom: 1px solid #e5e7eb;
            }
        }

        #editor {
            font-family: 'Fira Code', monospace;
            resize: none;
            outline: none;
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1.5rem;
            line-height: 1.6;
            overflow-y: auto;
            font-size: 14px;
        }

        #preview {
            background-color: white;
            color: #333;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* é¢„è§ˆåŒºåˆ—è¡¨æ ·å¼å¢å¼º */
        #preview ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        #preview ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1rem; }
        #preview li { margin-bottom: 0.5rem; }
        
        /* é¢„è§ˆåŒºåˆ†å‰²çº¿æ ·å¼ */
        #preview hr { border: 0; border-top: 2px solid #eaeaea; margin: 2rem 0; }

        /* é¢„è§ˆåŒºè¡¨æ ¼æ ·å¼ */
        #preview table { border-collapse: collapse; width: 100%; margin: 1em 0; overflow-x: auto; display: block; }
        #preview th, #preview td { border: 1px solid #e5e7eb; padding: 8px 12px; min-width: 80px; }
        #preview th { background: #f9fafb; }

        /* å³é”®èœå•æ ·å¼ */
        #context-menu {
            position: fixed;
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #ddd;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-radius: 12px;
            z-index: 1000;
            min-width: 180px;
            overflow: hidden;
        }

        #context-menu button {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            font-size: 14px;
            color: #333;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        #context-menu button:last-child { border-bottom: none; }
        #context-menu button:active { background: #e5e7eb; }

        /* Debug å¼¹çª—å“åº”å¼ */
        #debug-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            background: white;
            z-index: 2000;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            flex-direction: column;
        }

        #modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1999;
            backdrop-filter: blur(2px);
        }

        /* æŒ‰é’®ä¸äº¤äº’ä¼˜åŒ– */
        .btn { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            touch-action: manipulation;
        }
        .btn:active { transform: scale(0.92); opacity: 0.8; }

        /* å¯¼å‡ºä¸­æç¤º */
        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 3000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <header class="bg-white border-b px-4 py-3 md:px-6 md:py-4 flex flex-row justify-between items-center z-10 shadow-sm">
        <div class="flex flex-col overflow-hidden">
            <h1 class="text-lg md:text-xl font-bold text-gray-800 truncate">Markdown è½¬æ¢ä¸“å®¶</h1>
            <p class="hidden md:block text-xs text-gray-500">æ”¯æŒå®æ—¶é¢„è§ˆã€Docxã€é•¿å›¾ä¸ PDF å¯¼å‡º/æ‰“å°</p>
        </div>
        <div class="flex space-x-2">
            <button onclick="openWatermarkSettings()" class="btn bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-md flex items-center shrink-0">
                <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                    <path d="M2 17l10 5 10-5"></path>
                    <path d="M2 12l10 5 10-5"></path>
                </svg>
                <span class="hidden sm:inline">æ°´å°è®¾ç½®</span>
                <span class="inline sm:hidden">æ°´å°</span>
            </button>
            <button onclick="exportLongImage()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-md flex items-center shrink-0">
                <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <span class="hidden sm:inline">å¯¼å‡ºé•¿å›¾</span>
                <span class="inline sm:hidden">é•¿å›¾</span>
            </button>
            <button onclick="exportPdf()" class="btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-md flex items-center shrink-0">
                <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <span class="hidden sm:inline">å¯¼å‡ºPDF/æ‰“å°</span>
                <span class="inline sm:hidden">PDF/æ‰“å°</span>
            </button>
            <button onclick="exportDocx()" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-md flex items-center shrink-0">
                <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                    <polyline points="16 6 12 2 8 6"></polyline>
                    <line x1="12" y1="2" x2="12" y2="15"></line>
                </svg>
                <span class="hidden sm:inline">å¯¼å‡º Docx</span>
                <span class="inline sm:hidden">Docx</span>
            </button>
        </div>
    </header>

    <main class="editor-container">
        <textarea id="editor" class="w-1/2 h-full border-r" placeholder="åœ¨æ­¤è¾“å…¥ Markdown å†…å®¹..."></textarea>
        <div id="preview" class="w-1/2 h-full prose prose-sm md:prose-base max-w-none"></div>
    </main>

    <!-- å³é”®èœå• -->
    <div id="context-menu">
        <button onclick="debugSelection()">ğŸ” Debug é€‰ä¸­å†…å®¹</button>
        <button onclick="copyRaw()">ğŸ“‹ å¤åˆ¶åŸæ–‡</button>
    </div>

    <!-- Debug å¼¹çª— -->
    <div id="modal-overlay" onclick="closeModal()"></div>
    <div id="debug-modal" class="p-4 md:p-6 overflow-hidden flex flex-col">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="font-bold text-lg text-gray-800">è§£æè°ƒè¯•å™¨</h3>
            <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600">âœ•</button>
        </div>
        <div class="flex-1 overflow-auto space-y-4">
            <div>
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">åŸå§‹ Markdown</span>
                <pre id="debug-raw" class="mt-1 bg-gray-900 text-green-400 p-4 rounded-xl text-xs md:text-sm whitespace-pre-wrap font-mono border border-gray-700"></pre>
            </div>
            <div>
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">è§£æå HTML</span>
                <pre id="debug-html" class="mt-1 bg-gray-100 p-4 rounded-xl text-xs md:text-sm whitespace-pre-wrap text-blue-700 border border-gray-200 font-mono"></pre>
            </div>
        </div>
    </div>

    <!-- æ°´å°è®¾ç½®å¼¹çª— -->
    <div id="watermark-modal" class="fixed inset-0 z-[2000] hidden items-center justify-center" style="background: rgba(0,0,0,0.5);">
        <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-md p-6 relative">
            <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 class="font-bold text-lg text-gray-800">æ°´å°è®¾ç½®</h3>
                <button onclick="closeWatermarkModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200">âœ•</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ°´å°å†…å®¹</label>
                    <input type="text" id="watermark-text" placeholder="è¯·è¾“å…¥æ°´å°æ–‡å­—" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" value="å†…éƒ¨èµ„æ–™">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å€¾æ–œè§’åº¦</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="watermark-angle" min="0" max="90" value="45" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <span id="angle-value" class="text-sm text-gray-600 w-10 text-right">45Â°</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é€æ˜åº¦</label>
                        <div class="flex items-center space-x-2">
                            <input type="range" id="watermark-opacity" min="10" max="100" value="50" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <span id="opacity-value" class="text-sm text-gray-600 w-10 text-right">50%</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å­—ä½“</label>
                    <select id="watermark-font" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                        <option value="SimSun, serif">å®‹ä½“</option>
                        <option value="SimHei, sans-serif">é»‘ä½“</option>
                        <option value="Microsoft YaHei, sans-serif">å¾®è½¯é›…é»‘</option>
                        <option value="KaiTi, serif">æ¥·ä½“</option>
                        <option value="FangSong, serif">ä»¿å®‹</option>
                        <option value="Arial, sans-serif">Arial</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å­—ä½“å¤§å°</label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="watermark-fontsize" min="12" max="36" value="18" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="fontsize-value" class="text-sm text-gray-600 w-10 text-right">18px</span>
                    </div>
                </div>
                <div class="flex items-center justify-between pt-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="watermark-enabled" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500" checked>
                        <span class="text-sm text-gray-700">å¯ç”¨æ°´å°</span>
                    </label>
                    <button onclick="previewWatermark()" class="text-sm text-purple-600 hover:text-purple-800 font-medium">é¢„è§ˆæ•ˆæœ</button>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeWatermarkModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">å–æ¶ˆ</button>
                <button onclick="saveWatermarkSettings()" class="px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-lg hover:bg-purple-700">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-gray-600 font-medium">æ­£åœ¨ç”Ÿæˆé•¿å›¾ï¼Œè¯·ç¨å€™...</p>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const contextMenu = document.getElementById('context-menu');
        const debugModal = document.getElementById('debug-modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const loadingOverlay = document.getElementById('loading-overlay');

        let isSyncingEditor = false;
        let isSyncingPreview = false;
        let markdownBlocks = [];
        let isDefaultContent = true;

        let watermarkSettings = {
            enabled: true,
            text: 'å†…éƒ¨èµ„æ–™',
            angle: 45,
            opacity: 50,
            font: 'SimSun, serif',
            fontSize: 18
        };

        const INITIAL_CONTENT = `# ğŸš€ æ¬¢è¿ä½¿ç”¨ Markdown è½¬æ¢ä¸“å®¶ Pro

æœ¬å·¥å…·å·²å…¨é¢é€‚é…ç§»åŠ¨ç«¯ã€‚åœ¨æ‰‹æœºä¸Šï¼Œç¼–è¾‘å™¨ä¸é¢„è§ˆåŒºå°†è‡ªåŠ¨åˆ‡æ¢ä¸ºä¸Šä¸‹å †å å¸ƒå±€ï¼Œæ–¹ä¾¿éšæ—¶è®°å½•çµæ„Ÿã€‚

---

### ğŸ¨ å“åº”å¼ä¼˜åŒ–è¯´æ˜
1. **è§¦æ§æ”¯æŒ**ï¼šä¼˜åŒ–äº†å¯¼å‡ºæŒ‰é’®çš„ç‚¹å‡»é¢ç§¯ï¼Œå¹¶æ”¯æŒé•¿æŒ‰å”¤èµ·è°ƒè¯•èœå•ã€‚
2. **å¸ƒå±€åˆ‡æ¢**ï¼šå½“å±å¹•å®½åº¦å°äº 768px æ—¶ï¼Œå¸ƒå±€ç”±æ¨ªå‘è½¬ä¸ºçºµå‘ã€‚
3. **è¡¨æ ¼é€‚é…**ï¼šè¡¨æ ¼æ”¯æŒæ¨ªå‘æ»‘åŠ¨ï¼Œä¸ä¼šæŒ¤å‹é¡µé¢ã€‚

### ğŸ“ ç»“æ„åŒ–å†…å®¹æ¼”ç¤º

#### 1. å¤šçº§åˆ—è¡¨ä¸å±‚çº§ç»“æ„
* **ç§»åŠ¨ç«¯ç‰¹æ€§**
    1. æ”¯æŒæ‰‹åŠ¿æ»šåŠ¨ã€‚
    2. æ–‡å­—å¤§å°è‡ªåŠ¨è°ƒæ•´ï¼Œç¡®ä¿å¯è¯»æ€§ã€‚

#### 2. æ•°å­¦å…¬å¼å¼•æ“
è¿™é‡Œæ˜¯ä¸€ä¸ªå…³äºæ­£æ€åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•°å…¬å¼ï¼š
$$ f(x | \\mu, \\sigma^2) = \\frac{1}{\\sqrt{2\\pi\\sigma^2}} e^{-\\frac{(x-\\mu)^2}{2\\sigma^2}} $$

> å°è¯•åœ¨æ‰‹æœºä¸Šç‚¹å‡»å³ä¸Šè§’çš„åˆ†äº«å›¾æ ‡è¿›è¡Œå¯¼å‡ºã€‚`;

        function getFileName(extension) {
            const lines = editor.value.split('\n');
            let firstLine = '';
            for(let line of lines) {
                if(line.trim()) { firstLine = line; break; }
            }
            if (!firstLine) return `document.${extension}`;
            
            const cleanLine = firstLine.replace(/[#*`>]/g, '').trim();
            const punctuationRegex = /[ï¼Œã€‚ï¼ï¼Ÿï¼šï¼›ï¼ˆï¼‰ã€ã€‘ã€Šã€‹ã€,.!?:;()\[\]{}]/;
            const match = cleanLine.match(punctuationRegex);
            
            let fileName = '';
            if (match) {
                fileName = cleanLine.substring(0, match.index).trim();
            }
            
            if (!fileName) {
                fileName = cleanLine.substring(0, 20) || 'document';
            }
            
            return `${fileName}.${extension}`;
        }

        function decodeHTMLEntities(text) {
            const entities = { '&amp;': '&', '&lt;': '<', '&gt;': '>', '&quot;': '"', '&#39;': "'", '&nbsp;': ' ' };
            return text.replace(/&amp;|&lt;|&gt;|&quot;|&#39;|&nbsp;/g, m => entities[m]);
        }

        function renderMath(text) {
            text = text.replace(/\$\$(.+?)\$\$/gs, (m, f) => {
                const clean = decodeHTMLEntities(f);
                try {
                    const rendered = katex.renderToString(clean, { displayMode: true, throwOnError: false });
                    return `<div class="math-block my-4 overflow-x-auto" data-latex="${clean}" data-display="true">${rendered}</div>`;
                } catch(e) { return m; }
            });
            text = text.replace(/\$([^\$\n]+?)\$/g, (m, f) => {
                const clean = decodeHTMLEntities(f);
                try {
                    const rendered = katex.renderToString(clean, { displayMode: false, throwOnError: false });
                    return `<span class="math-inline" data-latex="${clean}" data-display="false">${rendered}</span></span>`;
                } catch(e) { return m; }
            });
            return text;
        }

        function preprocessMarkdown(text) {
            let processed = text.replace(/ã€€/g, ' ');
            
            // è§£å†³ä¸­æ–‡/æ ‡ç‚¹ä¸åŠ ç²—ç¬¦å·ç›¸é‚»å¯¼è‡´æ— æ³•è§£æçš„é—®é¢˜
            processed = processed.replace(/([^\s\n])\*\*([^\s\n*].*?[^\s\n*])\*\*([^\s\n])/g, '$1 **$2** $3');
            processed = processed.replace(/([^\s\n])\*\*([^\s\n*].*?[^\s\n*])\*\*/g, '$1 **$2**');
            processed = processed.replace(/\*\*([^\s\n*].*?[^\s\n*])\*\*([^\s\n])/g, '**$2** $3');

            processed = processed.replace(/^(#+.*)\n([^-*1-9\s])/gm, '$1\n\n$2');
            processed = processed.replace(/\n([-*_]){3,}\n/g, '\n\n$1$1$1\n\n');
            processed = processed.replace(/([^\n])\n([-]{3,})(\s|$)/g, '$1\n\n$2$3');
            return processed;
        }

        function updatePreview() {
            const val = editor.value;
            markdownBlocks = val.split(/\n\n+/);
            const cleanMarkdown = preprocessMarkdown(val);
            const html = marked.parse(cleanMarkdown);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = renderMath(html);
            
            Array.from(tempDiv.children).forEach((child, index) => {
                child.setAttribute('data-index', index);
            });
            
            preview.innerHTML = tempDiv.innerHTML;
        }

        editor.addEventListener('input', () => {
            isDefaultContent = false;
            updatePreview();
        });

        editor.addEventListener('click', () => {
            if (isDefaultContent && editor.value === INITIAL_CONTENT) {
                editor.value = '';
                isDefaultContent = false;
                updatePreview();
            }
        });

        const isMobile = () => window.innerWidth <= 768;

        editor.addEventListener('scroll', () => {
            if (!isSyncingEditor && !isMobile()) {
                isSyncingPreview = true;
                const percentage = editor.scrollTop / (editor.scrollHeight - editor.clientHeight);
                preview.scrollTop = percentage * (preview.scrollHeight - preview.clientHeight);
                setTimeout(() => isSyncingPreview = false, 50);
            }
        });

        preview.addEventListener('scroll', () => {
            if (!isSyncingPreview && !isMobile()) {
                isSyncingEditor = true;
                const percentage = preview.scrollTop / (preview.scrollHeight - preview.clientHeight);
                editor.scrollTop = percentage * (editor.scrollHeight - editor.clientHeight);
                setTimeout(() => isSyncingEditor = false, 50);
            }
        });

        let lastSelectedHTML = '';
        let lastSelectedRaw = '';

        const handleContextMenu = (e, isFromEditor) => {
            let selectedText = "";
            if (isFromEditor) {
                selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
                if (selectedText.trim()) {
                    lastSelectedRaw = selectedText;
                    lastSelectedHTML = marked.parse(preprocessMarkdown(selectedText));
                }
            } else {
                const selection = window.getSelection();
                selectedText = selection.toString();
                const container = selection.anchorNode?.parentElement?.closest('[data-index]');
                if (container) {
                    const idx = parseInt(container.getAttribute('data-index'));
                    lastSelectedHTML = container.outerHTML;
                    lastSelectedRaw = markdownBlocks[idx] || "æœªæ‰¾åˆ°æºç æ®µè½";
                } else if (selectedText.trim()) {
                    lastSelectedRaw = "é€‰ä¸­çš„çº¯æ–‡æœ¬: " + selectedText;
                    lastSelectedHTML = selection.anchorNode?.parentElement?.innerHTML || "";
                }
            }

            if (selectedText.trim()) {
                e.preventDefault();
                contextMenu.style.display = 'block';
                let x = e.pageX;
                if (x + 180 > window.innerWidth) x = window.innerWidth - 190;
                contextMenu.style.left = x + 'px';
                contextMenu.style.top = e.pageY + 'px';
            }
        };

        editor.addEventListener('contextmenu', (e) => handleContextMenu(e, true));
        preview.addEventListener('contextmenu', (e) => handleContextMenu(e, false));
        document.addEventListener('click', () => contextMenu.style.display = 'none');

        let touchTimer;
        const touchDuration = 600;
        const handleTouchStart = (e, isFromEditor) => {
            touchTimer = setTimeout(() => handleContextMenu(e.touches[0], isFromEditor), touchDuration);
        };
        const handleTouchEnd = () => clearTimeout(touchTimer);
        
        editor.addEventListener('touchstart', (e) => handleTouchStart(e, true), {passive: true});
        editor.addEventListener('touchend', handleTouchEnd);
        preview.addEventListener('touchstart', (e) => handleTouchStart(e, false), {passive: true});
        preview.addEventListener('touchend', handleTouchEnd);

        function debugSelection() {
            document.getElementById('debug-raw').textContent = lastSelectedRaw;
            document.getElementById('debug-html').textContent = lastSelectedHTML;
            debugModal.style.display = 'flex';
            modalOverlay.style.display = 'block';
        }

        function closeModal() {
            debugModal.style.display = 'none';
            modalOverlay.style.display = 'none';
        }

        function copyRaw() {
            if (lastSelectedRaw) {
                const input = document.createElement('textarea');
                input.value = lastSelectedRaw;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
            }
        }

        function openWatermarkSettings() {
            const modal = document.getElementById('watermark-modal');
            modal.style.display = 'flex';
            
            document.getElementById('watermark-text').value = watermarkSettings.text;
            document.getElementById('watermark-angle').value = watermarkSettings.angle;
            document.getElementById('watermark-opacity').value = watermarkSettings.opacity;
            document.getElementById('watermark-font').value = watermarkSettings.font;
            document.getElementById('watermark-fontsize').value = watermarkSettings.fontSize;
            document.getElementById('watermark-enabled').checked = watermarkSettings.enabled;
            
            document.getElementById('angle-value').textContent = watermarkSettings.angle + 'Â°';
            document.getElementById('opacity-value').textContent = watermarkSettings.opacity + '%';
            document.getElementById('fontsize-value').textContent = watermarkSettings.fontSize + 'px';
        }

        function closeWatermarkModal() {
            document.getElementById('watermark-modal').style.display = 'none';
        }

        function saveWatermarkSettings() {
            watermarkSettings = {
                enabled: document.getElementById('watermark-enabled').checked,
                text: document.getElementById('watermark-text').value || 'å†…éƒ¨èµ„æ–™',
                angle: parseInt(document.getElementById('watermark-angle').value),
                opacity: parseInt(document.getElementById('watermark-opacity').value),
                font: document.getElementById('watermark-font').value,
                fontSize: parseInt(document.getElementById('watermark-fontsize').value)
            };
            closeWatermarkModal();
        }

        function previewWatermark() {
            const tempSettings = {
                enabled: true,
                text: document.getElementById('watermark-text').value || 'å†…éƒ¨èµ„æ–™',
                angle: parseInt(document.getElementById('watermark-angle').value),
                opacity: parseInt(document.getElementById('watermark-opacity').value),
                font: document.getElementById('watermark-font').value,
                fontSize: parseInt(document.getElementById('watermark-fontsize').value)
            };
            
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('æ— æ³•æ‰“å¼€é¢„è§ˆçª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
                return;
            }
            
            const watermarkCSS = generateWatermarkCSS(tempSettings);
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>æ°´å°é¢„è§ˆ</title>
                    <style>
                        body {
                            font-family: 'Times New Roman', Georgia, serif;
                            padding: 40px;
                            background: white;
                        }
                        .content {
                            font-size: 14pt;
                            line-height: 1.8;
                            color: #333;
                        }
                        ${watermarkCSS}
                    </style>
                </head>
                <body>
                    <div class="watermark-layer"></div>
                    <div class="content">
                        <h1>æ°´å°æ•ˆæœé¢„è§ˆ</h1>
                        <p>è¿™æ˜¯ä¸€æ®µç¤ºä¾‹æ–‡æœ¬ï¼Œç”¨äºå±•ç¤ºæ°´å°æ•ˆæœã€‚æ°´å°ä¼šä»¥å€¾æ–œè§’åº¦è¦†ç›–æ•´ä¸ªé¡µé¢ã€‚</p>
                        <p>æ°´å°å†…å®¹ï¼š${tempSettings.text}</p>
                        <p>å€¾æ–œè§’åº¦ï¼š${tempSettings.angle}Â°</p>
                        <p>é€æ˜åº¦ï¼š${tempSettings.opacity}%</p>
                        <p>å­—ä½“å¤§å°ï¼š${tempSettings.fontSize}px</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function generateWatermarkCSS(settings) {
            if (!settings.enabled || !settings.text) return '';
            
            const opacity = settings.opacity / 100;
            const angle = -settings.angle;
            
            return `
                .watermark-layer {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 9999;
                    overflow: hidden;
                }
                .watermark-layer::before {
                    content: '';
                    position: absolute;
                    top: -50%;
                    left: -50%;
                    width: 200%;
                    height: 200%;
                    background-image: repeating-linear-gradient(
                        ${angle}deg,
                        transparent,
                        transparent 80px,
                        rgba(0, 0, 0, 0) 80px,
                        rgba(0, 0, 0, 0) 80px
                    );
                }
                .watermark-layer::after {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150'%3E%3Ctext x='50%25' y='50%25' font-family='${encodeURIComponent(settings.font)}' font-size='${settings.fontSize}' fill='rgba(0,0,0,${opacity})' text-anchor='middle' dominant-baseline='middle' transform='rotate(${angle}, 100, 75)'%3E${encodeURIComponent(settings.text)}%3C/text%3E%3C/svg%3E");
                    background-repeat: repeat;
                    pointer-events: none;
                }
            `;
        }

        document.getElementById('watermark-angle').addEventListener('input', function() {
            document.getElementById('angle-value').textContent = this.value + 'Â°';
        });

        document.getElementById('watermark-opacity').addEventListener('input', function() {
            document.getElementById('opacity-value').textContent = this.value + '%';
        });

        document.getElementById('watermark-fontsize').addEventListener('input', function() {
            document.getElementById('fontsize-value').textContent = this.value + 'px';
        });

        async function exportLongImage() {
            if (!editor.value) return;
            loadingOverlay.style.display = 'flex';

            try {
                const container = document.createElement('div');
                container.style.position = 'absolute';
                container.style.left = '-9999px';
                container.style.width = '375px';
                container.style.backgroundColor = 'white';
                container.style.padding = '30px';
                
                container.innerHTML = preview.innerHTML;
                
                const style = document.createElement('style');
                style.textContent = `
                    .export-wrapper { font-family: sans-serif; }
                    .export-wrapper ul { list-style-type: disc !important; padding-left: 1.5rem !important; margin-bottom: 1rem !important; }
                    .export-wrapper ol { list-style-type: decimal !important; padding-left: 1.5rem !important; margin-bottom: 1rem !important; }
                    .export-wrapper li { display: list-item !important; margin-bottom: 0.5rem !important; }
                    .export-wrapper ul > li::before, .export-wrapper ol > li::before { display: none !important; }
                `;
                container.appendChild(style);
                container.className = 'export-wrapper prose prose-base max-w-none leading-relaxed';
                
                document.body.appendChild(container);

                await new Promise(resolve => setTimeout(resolve, 500));

                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    windowWidth: 375
                });

                if (watermarkSettings.enabled && watermarkSettings.text) {
                    const ctx = canvas.getContext('2d');
                    const angle = -watermarkSettings.angle * Math.PI / 180;
                    const opacity = watermarkSettings.opacity / 100;
                    const fontSize = watermarkSettings.fontSize * 2;
                    
                    ctx.font = `${fontSize}px ${watermarkSettings.font}`;
                    ctx.fillStyle = `rgba(0, 0, 0, ${opacity})`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    const textWidth = ctx.measureText(watermarkSettings.text).width;
                    const gapX = textWidth + 100;
                    const gapY = fontSize * 3;
                    
                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(angle);
                    
                    const diagonal = Math.sqrt(canvas.width * canvas.width + canvas.height * canvas.height);
                    const startX = -diagonal;
                    const endX = diagonal;
                    const startY = -diagonal;
                    const endY = diagonal;
                    
                    for (let y = startY; y < endY; y += gapY) {
                        for (let x = startX; x < endX; x += gapX) {
                            ctx.fillText(watermarkSettings.text, x, y);
                        }
                    }
                    
                    ctx.restore();
                }

                const link = document.createElement('a');
                link.download = getFileName('png');
                link.href = canvas.toDataURL('image/png');
                link.click();

                document.body.removeChild(container);
            } catch (err) {
                console.error('å¯¼å‡ºå¤±è´¥:', err);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function exportDocx() {
            if (!editor.value) return;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = preview.innerHTML;

            tempDiv.querySelectorAll('[data-latex]').forEach(el => {
                const latex = el.getAttribute('data-latex');
                const isDisplay = el.getAttribute('data-display') === 'true';
                try {
                    const mathml = katex.renderToString(latex, { displayMode: isDisplay, output: 'mathml' });
                    const wrapper = document.createElement('span');
                    wrapper.innerHTML = mathml;
                    el.parentNode.replaceChild(wrapper, el);
                } catch (err) { console.error(err); }
            });

            tempDiv.querySelectorAll('li').forEach(li => {
                const innerPs = li.querySelectorAll('p');
                if (innerPs.length > 0) {
                    innerPs.forEach(p => {
                        const fragment = document.createDocumentFragment();
                        while(p.firstChild) fragment.appendChild(p.firstChild);
                        p.parentNode.replaceChild(fragment, p);
                    });
                }
                li.innerHTML = li.innerHTML.trim().replace(/\n/g, ' ');
            });

            const content = tempDiv.innerHTML;
            const converted = htmlDocx.asBlob(`
                <!DOCTYPE html>
                <head>
                    <meta charset="utf-8">
                    <style>
                        body { font-family: 'Arial', sans-serif; line-height: 1.5; }
                        table { border-collapse: collapse; width: 100%; margin: 12pt 0; }
                        th, td { border: 1pt solid #cccccc; padding: 6pt; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        hr { border: 0; border-top: 1pt solid #eeeeee; margin: 15pt 0; }
                        ul, ol { margin-left: 0; padding-left: 25pt; margin-top: 6pt; margin-bottom: 6pt; }
                        li { margin-bottom: 3pt; margin-top: 3pt; }
                        li > span, li > div { display: inline; }
                        h1 { font-size: 22pt; margin-bottom: 12pt; margin-top: 18pt; font-weight: bold; }
                        h2 { font-size: 18pt; margin-top: 16pt; margin-bottom: 10pt; font-weight: bold; }
                        h3 { font-size: 14pt; margin-top: 14pt; margin-bottom: 8pt; font-weight: bold; }
                        p { margin-bottom: 8pt; margin-top: 0; }
                    </style>
                </head>
                <body>${content}<\/body>
                <\/html>
            `);

            const link = document.createElement('a');
            link.href = URL.createObjectURL(converted);
            link.download = getFileName('docx');
            link.click();
        }

        function exportPdf() {
            if (!editor.value) return;
            
            // åˆ›å»ºä¸€ä¸ªæ–°çª—å£ç”¨äºæ‰“å°
            const printWindow = window.open('', '_blank');
            
            if (!printWindow) {
                alert('æ— æ³•æ‰“å¼€æ‰“å°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
                return;
            }
            
            // è·å–é¢„è§ˆå†…å®¹å¹¶å¤„ç†
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = preview.innerHTML;
            
            // å¤„ç†æ•°å­¦å…¬å¼
            tempDiv.querySelectorAll('[data-latex]').forEach(el => {
                const latex = el.getAttribute('data-latex');
                const isDisplay = el.getAttribute('data-display') === 'true';
                if (latex) {
                    try {
                        el.innerHTML = katex.renderToString(latex, { 
                            displayMode: isDisplay, 
                            throwOnError: false 
                        });
                    } catch(e) { el.innerHTML = latex; }
                }
            });
            
            // å¤„ç†åˆ—è¡¨
            tempDiv.querySelectorAll('li').forEach(li => {
                const innerPs = li.querySelectorAll('p');
                if (innerPs.length > 0) {
                    innerPs.forEach(p => {
                        const fragment = document.createDocumentFragment();
                        while(p.firstChild) fragment.appendChild(p.firstChild);
                        p.parentNode.replaceChild(fragment, p);
                    });
                }
                li.innerHTML = li.innerHTML.trim().replace(/\n/g, ' ');
            });
            
            const content = tempDiv.innerHTML;
            const watermarkCSS = generateWatermarkCSS(watermarkSettings);
            const watermarkLayer = watermarkSettings.enabled && watermarkSettings.text ? '<div class="watermark-layer"></div>' : '';
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>${getFileName('pdf')}</title>
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
                    <style>
                        @page { size: A4; margin: 15mm 20mm; }
                        body {
                            font-family: 'Times New Roman', Georgia, serif;
                            font-size: 12pt;
                            line-height: 1.6;
                            color: #333;
                            max-width: 100%;
                            padding: 0;
                            margin: 0;
                        }
                        h1 { font-size: 20pt; margin: 16pt 0 12pt 0; font-weight: bold; }
                        h2 { font-size: 16pt; margin: 14pt 0 10pt 0; font-weight: bold; }
                        h3 { font-size: 14pt; margin: 12pt 0 8pt 0; font-weight: bold; }
                        h4 { font-size: 12pt; margin: 10pt 0 6pt 0; font-weight: bold; }
                        p { margin: 8pt 0; text-align: justify; }
                        ul, ol { margin: 8pt 0; padding-left: 25pt; }
                        li { margin: 4pt 0; }
                        table { border-collapse: collapse; width: 100%; margin: 12pt 0; }
                        th, td { border: 1pt solid #ccc; padding: 6pt 8pt; text-align: left; }
                        th { background: #f5f5f5; font-weight: bold; }
                        hr { border: 0; border-top: 1pt solid #ddd; margin: 15pt 0; }
                        blockquote { border-left: 3pt solid #ccc; margin: 10pt 0; padding-left: 12pt; color: #666; font-style: italic; }
                        code { background: #f5f5f5;padding: 2pt 4pt; font-family: 'Courier New', monospace; font-size: 10pt; }
                        pre { background: #f5f5f5; padding: 12pt; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 10pt; }
                        img { max-width: 100%; height: auto; }
                        .math-block { text-align: center; margin: 12pt 0; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        ${watermarkCSS}
                    </style>
                </head>
                <body>${watermarkLayer}${content}</body>
                </html>
            `);
            
            printWindow.document.close();
            
            // ç­‰å¾…å†…å®¹åŠ è½½å®Œæˆåè§¦å‘æ‰“å°
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 500);
        }

        // åˆå§‹åŒ–å†…å®¹
        editor.value = INITIAL_CONTENT;
        updatePreview();
    </script>
</body>
</html>
